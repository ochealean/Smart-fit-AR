<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Registration - Shoe Shop Portal</title>
    <link rel="icon" href="../../images/smartfitImages/smartfitAR-logo.png" type="image/x-icon">
    <link rel="stylesheet" href="/customer/css/customer_register.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Google Maps JavaScript API -->
    <script>
        // Ensure initMap is globally available and waits for DOM
        window.initMap = function() {
            document.addEventListener('DOMContentLoaded', function() {
                const mapDiv = document.getElementById('map');
                if (!mapDiv) {
                    console.error('Map div not found');
                    return;
                }

                const { AdvancedMarkerElement } = google.maps.marker;

                map = new google.maps.Map(mapDiv, {
                    center: { lat: 14.5995, lng: 120.9842 }, // Default center: Philippines
                    zoom: 8,
                    mapId: '8ddbd8f389c81029930da3' // Your valid Map ID
                });

                marker = new AdvancedMarkerElement({
                    map: map,
                    position: null, // Initially no position
                    gmpDraggable: true, // Correct property for draggability
                    title: 'Customer Location'
                });

                // Hide marker initially until address is geocoded
                marker.visible = false;

                geocoder = new google.maps.Geocoder();

                // Add dragend listener using google.maps.event
                google.maps.event.addListener(marker, 'dragend', function() {
                    const position = marker.position;
                    if (position) {
                        document.getElementById('latitude').value = position.lat;
                        document.getElementById('longitude').value = position.lng;
                        document.getElementById('displayLatitude').textContent = position.lat.toFixed(6);
                        document.getElementById('displayLongitude').textContent = position.lng.toFixed(6);
                    }
                });

                // Handle "Locate on Map" button
                document.getElementById('locateMapBtn').addEventListener('click', function() {
                    const customerAddress = document.getElementById('address').value.trim();
                    const customerCity = document.getElementById('city').value.trim();
                    const customerState = document.getElementById('state').value.trim();
                    const customerZip = document.getElementById('zip').value.trim();
                    const customerCountry = document.getElementById('country').value.trim();

                    // Validate that all required address fields are filled
                    if (!customerAddress || !customerCity || !customerState || !customerZip) {
                        showErrorOverlay(['Please fill in all address fields (Street Address, City, Province, and ZIP Code) before locating on map.']);
                        return;
                    }

                    // Create multiple address formats to improve geocoding accuracy
                    const addressFormats = [
                        // Format 1: Full detailed address (highest priority)
                        `${customerAddress}, ${customerCity}, ${customerState} ${customerZip}, ${customerCountry}`,
                        // Format 2: Address + City + Province (remove ZIP if problematic)
                        `${customerAddress}, ${customerCity}, ${customerState}, ${customerCountry}`,
                        // Format 3: Just address and city
                        `${customerAddress}, ${customerCity}, ${customerCountry}`,
                        // Format 4: Address-focused format
                        `${customerAddress}, ${customerCity}`
                    ];

                    console.log('Attempting to geocode address:', customerAddress);
                    
                    // Try geocoding with increasing specificity
                    attemptGeocoding(addressFormats, 0);
                    
                    function attemptGeocoding(formats, index) {
                        if (index >= formats.length) {
                            // All formats failed, show error and allow manual placement
                            console.error('All geocoding attempts failed');
                            showErrorOverlay([
                                'Unable to pinpoint the exact street address.',
                                'The marker has been placed in the general area.',
                                'Please manually drag the marker to your exact location.'
                            ]);
                            
                            // Center on the city as fallback
                            geocoder.geocode({
                                address: `${customerCity}, ${customerState}, ${customerCountry}`
                            }, function(results, status) {
                                if (status === google.maps.GeocoderStatus.OK) {
                                    const location = results[0].geometry.location;
                                    map.setCenter(location);
                                    map.setZoom(15);
                                    marker.position = { lat: location.lat(), lng: location.lng() };
                                    marker.visible = true;
                                    updateCoordinates(location.lat(), location.lng());
                                }
                            });
                            return;
                        }

                        const currentAddress = formats[index];
                        console.log(`Attempt ${index + 1}: ${currentAddress}`);

                        geocoder.geocode({ 
                            address: currentAddress,
                            region: 'ph' // Use region instead of componentRestrictions for better results
                        }, function(results, status) {
                            if (status === google.maps.GeocoderStatus.OK) {
                                const location = results[0].geometry.location;
                                const formattedAddress = results[0].formatted_address;
                                const locationType = results[0].geometry.location_type;
                                
                                console.log(`Geocoding successful (Attempt ${index + 1}):`, formattedAddress);
                                console.log('Location type:', locationType);
                                console.log('Exact coordinates:', location.lat(), location.lng());

                                // Check if we got a precise location (ROOFTOP, RANGE_INTERPOLATED, or GEOMETRIC_CENTER)
                                const isPrecise = ['ROOFTOP', 'RANGE_INTERPOLATED', 'GEOMETRIC_CENTER'].includes(locationType);
                                
                                map.setCenter(location);
                                map.setZoom(isPrecise ? 17 : 15); // Higher zoom for precise locations
                                
                                marker.position = {
                                    lat: location.lat(),
                                    lng: location.lng()
                                };
                                
                                marker.visible = true;
                                updateCoordinates(location.lat(), location.lng());

                                if (!isPrecise) {
                                    // If not precise, inform the user to adjust manually
                                    showErrorOverlay([
                                        'Approximate location found.',
                                        'Please manually drag the marker to your exact location for better accuracy.'
                                    ]);
                                } else {
                                    console.log('Precise location found!');
                                }
                                
                            } else if (status === google.maps.GeocoderStatus.ZERO_RESULTS) {
                                console.log(`Attempt ${index + 1} failed: No results`);
                                // Try next format
                                attemptGeocoding(formats, index + 1);
                            } else {
                                console.log(`Attempt ${index + 1} failed: ${status}`);
                                // Try next format
                                attemptGeocoding(formats, index + 1);
                            }
                        });
                    }

                    function updateCoordinates(lat, lng) {
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        document.getElementById('displayLatitude').textContent = lat.toFixed(6);
                        document.getElementById('displayLongitude').textContent = lng.toFixed(6);
                    }
                });

                // Enhanced address autocomplete for better street-level accuracy
                function initializeAddressAutocomplete() {
                    const addressInput = document.getElementById('address');
                    if (addressInput && google.maps.places) {
                        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
                            componentRestrictions: { country: 'ph' },
                            fields: ['address_components', 'geometry', 'formatted_address', 'name'],
                            types: ['address', 'establishment'] // Include establishments for better results
                        });

                        autocomplete.addListener('place_changed', function() {
                            const place = autocomplete.getPlace();
                            if (!place.geometry) {
                                console.log('No details available for input: ' + place.name);
                                return;
                            }

                            console.log('Place autocomplete result:', place);

                            // Extract address components
                            extractAndFillAddressComponents(place);
                            
                            // Auto-center map on selected location
                            const location = place.geometry.location;
                            map.setCenter(location);
                            map.setZoom(17);
                            
                            marker.position = {
                                lat: location.lat(),
                                lng: location.lng()
                            };
                            marker.visible = true;
                            
                            updateCoordinates(location.lat(), location.lng());
                        });

                        // Add input event listener to help with manual addresses
                        addressInput.addEventListener('blur', function() {
                            if (this.value.trim() && !this.getAttribute('data-autocomplete-used')) {
                                // User typed manually, try to geocode just the street address
                                setTimeout(() => {
                                    document.getElementById('locateMapBtn').click();
                                }, 500);
                            }
                            this.removeAttribute('data-autocomplete-used');
                        });

                        // Mark when autocomplete is used
                        addressInput.addEventListener('change', function() {
                            this.setAttribute('data-autocomplete-used', 'true');
                        });
                    }
                }

                function extractAndFillAddressComponents(place) {
                    let streetNumber = '';
                    let route = '';
                    let locality = '';
                    let administrativeArea = '';
                    let postalCode = '';

                    for (const component of place.address_components) {
                        const componentType = component.types[0];
                        
                        switch (componentType) {
                            case 'street_number':
                                streetNumber = component.long_name;
                                break;
                            case 'route':
                                route = component.long_name;
                                break;
                            case 'locality':
                            case 'sublocality_level_1':
                            case 'sublocality':
                                if (!locality) locality = component.long_name;
                                break;
                            case 'administrative_area_level_1':
                                administrativeArea = component.long_name;
                                break;
                            case 'administrative_area_level_2':
                                if (!administrativeArea) administrativeArea = component.long_name;
                                break;
                            case 'postal_code':
                                postalCode = component.long_name;
                                break;
                        }
                    }

                    // Build the full street address
                    let fullAddress = '';
                    if (streetNumber && route) {
                        fullAddress = `${streetNumber} ${route}`;
                    } else if (route) {
                        fullAddress = route;
                    } else {
                        fullAddress = place.name || '';
                    }

                    // Update form fields
                    if (fullAddress) {
                        document.getElementById('address').value = fullAddress;
                    }
                    if (locality && !document.getElementById('city').value) {
                        document.getElementById('city').value = locality;
                    }
                    if (administrativeArea && !document.getElementById('state').value) {
                        document.getElementById('state').value = administrativeArea;
                    }
                    if (postalCode && !document.getElementById('zip').value) {
                        document.getElementById('zip').value = postalCode;
                    }
                }

                // Initialize address autocomplete when Places library is loaded
                if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                    initializeAddressAutocomplete();
                }
            });
        };

        // Global variables
        let map, marker, geocoder;

        // Overlay functions for Google Maps
        function showErrorOverlay(errors) {
            const errorContainer = document.getElementById('errorMessages');
            if (errorContainer) {
                errorContainer.innerHTML = '';
                errors.forEach(error => {
                    const errorElement = document.createElement('p');
                    errorElement.textContent = error;
                    errorContainer.appendChild(errorElement);
                });
                document.getElementById('errorOverlay').classList.add('active');
            }
        }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBiw-3TrRkU1hSU0_dEsn3fjUxXAZWcLrg&libraries=places,marker&callback=initMap"></script>
</head>

<body style="padding: 0;">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="overlay">
        <div class="overlay-content">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h2>Processing Registration...</h2>
            <p>Please wait while we create your account</p>
        </div>
    </div>

    <!-- Success Overlay -->
    <div id="successOverlay" class="overlay">
        <div class="overlay-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>Registration Successful!</h2>
            <h4>We've sent a verification email to your email account. Kindly check it to proceed!</h4>
            <p>Your customer account has been created successfully. You can now log in and start shopping.</p>
            <button id="closeOverlay" class="overlay-btn">Continue</button>
        </div>
    </div>

    <!-- Error Overlay -->
    <div id="errorOverlay" class="overlay">
        <div class="overlay-content">
            <div class="error-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h2>Registration Issues</h2>
            <div class="error-container">
                <div id="errorMessages" class="error-list">
                    <!-- Errors will be inserted here -->
                </div>
            </div>
            <button id="closeErrorOverlay" class="overlay-btn">Back to Form</button>
        </div>
    </div>

    <header class="register-header">
        <div class="header-content">
            <h1>Create Your Customer Account</h1>
            <p>Join thousands of happy customers and discover the perfect shoes for you</p>
            <div class="navigation-links">
                <a href="/index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Landing Page</a>
                <span>or</span>
                <a href="/shopowner/html/shop_register.html" class="shop-link">Register as a Shop Instead</a>
            </div>
        </div>
    </header>

    <div class="registration-container">
        <div class="registration-form">
            <form id="customerRegistrationForm">
                <div class="form-section">
                    <h2><i class="fas fa-user"></i> Personal Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name*</label>
                            <input type="text" id="firstName" name="firstName" required placeholder="Your first name">
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name*</label>
                            <input type="text" id="lastName" name="lastName" required placeholder="Your last name">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email*</label>
                        <input type="email" id="email" name="email" required placeholder="your@email.com">
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number*</label>
                        <div class="phone-input-container">
                            <span class="country-code">+63</span>
                            <input type="tel" id="phone" name="phone" required placeholder="9123456789" maxlength="10">
                        </div>
                        <small>Enter your 10-digit Philippine mobile number (without +63)</small>
                    </div>

                    <div class="form-group">
                        <label for="birthDate">Date of Birth*</label>
                        <input type="date" id="birthDate" name="birthDate" required min="1900-01-01" max="2025-12-31">
                    </div>

                    <div class="form-group">
                        <label>Gender</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="gender" value="male">
                                <span class="radio-custom"></span>
                                Male
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gender" value="female">
                                <span class="radio-custom"></span>
                                Female
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gender" value="other">
                                <span class="radio-custom"></span>
                                Other
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gender" value="prefer-not-to-say">
                                <span class="radio-custom"></span>
                                Prefer not to say
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2><i class="fas fa-map-marker-alt"></i> Address Information</h2>
                    <div class="form-group">
                        <label for="address">Street Address*</label>
                        <input type="text" id="address" name="address" required placeholder="House number and street name">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City*</label>
                            <input type="text" id="city" name="city" required placeholder="City">
                        </div>

                        <div class="form-group">
                            <label for="zip">ZIP/Postal Code*</label>
                            <input type="text" id="zip" name="zip" required placeholder="ZIP code" maxlength="4" pattern="[0-9]*" inputmode="numeric">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="state">Province*</label>
                            <select id="state" name="state" required>
                                <option value="Bataan" selected>Bataan</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="country">Country*</label>
                            <select id="country" name="country" required>
                                <option value="Philippines" selected>Philippines</option>
                            </select>
                        </div>
                    </div>

                    <!-- Map Location Section for Customer -->
                    <div class="form-group">
                        <label>Your Location on Map*</label>
                        <small class="instruction">Click 'Locate on Map' to automatically pin your location based on the address. You can drag the marker to adjust for better delivery accuracy.</small>
                        <button type="button" id="locateMapBtn" class="overlay-btn" style="margin-bottom: 1rem;">Locate on Map</button>
                        <div id="map" style="height: 300px; width: 100%; border-radius: 8px; border: 1px solid var(--gray-medium);"></div>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <!-- Display Latitude and Longitude -->
                        <div class="location-display">
                            <p>Latitude: <span id="displayLatitude">N/A</span></p>
                            <p>Longitude: <span id="displayLongitude">N/A</span></p>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2><i class="fas fa-lock"></i> Account Security</h2>
                    <div class="form-group">
                        <label for="username">Username*</label>
                        <input type="text" id="username" name="username" required placeholder="Choose a username">
                    </div>

                    <div class="form-group">
                        <label for="password">Password*</label>
                        <div class="password-input-container">
                            <input type="password" id="password" name="password" required placeholder="Create a password">
                            <button type="button" class="toggle-password" aria-label="Show password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-requirements">
                            <ul>
                                <li id="req-length">At least 8 characters</li>
                                <li id="req-uppercase">At least one uppercase letter</li>
                                <li id="req-number">At least one number</li>
                                <li id="req-special">At least one special character</li>
                            </ul>
                        </div>
                        <div class="password-strength">
                            <span class="strength-bar"></span>
                            <span class="strength-bar"></span>
                            <span class="strength-bar"></span>
                            <span class="strength-text">Password strength: Weak</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password*</label>
                        <div class="password-input-container">
                            <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm your password">
                            <button type="button" class="toggle-password" aria-label="Show password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="profilePhoto">Profile Photo</label>
                        <div class="file-upload-container">
                            <label for="profilePhoto" class="upload-label">
                                <div class="upload-preview" id="profilePreview">
                                    <i class="fas fa-user-circle"></i>
                                    <span>Upload Photo</span>
                                </div>
                            </label>
                            <input type="file" id="profilePhoto" name="profilePhoto" accept="image/*">
                        </div>
                        <small class="file-requirements">(JPEG or PNG - Max 2MB)</small>
                    </div>
                </div>

                <div class="form-section terms-section">
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                        <label for="agreeTerms">I agree to the <a href="/extras/termsofservice.html" target="_blank">Terms of Service</a> and <a href="/extras/privacypolicy.html" target="_blank">Privacy Policy</a>*</label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" id="registerButton" class="submit-btn">Create Account</button>
                    <p class="form-note">* Required fields. By creating an account, you agree to our terms and conditions.</p>
                </div>
            </form>
        </div>

        <div class="registration-benefits">
            <h2>Why Register With Us?</h2>
            <div class="benefit-card">
                <i class="fas fa-tags"></i>
                <h3>Exclusive Deals</h3>
                <p>Get access to special discounts and early sales notifications.</p>
            </div>

            <div class="benefit-card">
                <i class="fas fa-heart"></i>
                <h3>Wishlist</h3>
                <p>Save your favorite items and get notified when prices drop.</p>
            </div>

            <div class="benefit-card">
                <i class="fas fa-shipping-fast"></i>
                <h3>Faster Checkout</h3>
                <p>Save your shipping details for quicker purchases.</p>
            </div>

            <div class="benefit-card">
                <i class="fas fa-history"></i>
                <h3>Order History</h3>
                <p>Track all your purchases and easily reorder favorites.</p>
            </div>

            <div class="already-member">
                <p>Already have an account?</p>
                <a href="/login.html#customer" class="login-link">Login to your account</a>
            </div>
        </div>
    </div>

    <footer class="login-footer">
        <div class="footer-content">
            <p>&copy; 2025 Shoe Shop Portal. All rights reserved.</p>
            <nav>
                <a href="/">Home</a>
                <a href="/extras/privacypolicy.html">Privacy Policy</a>
                <a href="/extras/termsofservice.html">Terms of Service</a>
                <a href="/extras/contactus.html">Contact Us</a>
                <a href="/extras/aboutus.html">About Us</a>
            </nav>
        </div>
    </footer>

    <script src="/customer/js/customer_register.js" type="module"></script>
</body>
</html>